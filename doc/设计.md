http://www.52im.net/forum.php?mod=collection&action=view&ctid=7&fromop=all





http://www.52im.net/thread-3887-1-1.html

rpc: http://www.52im.net/thread-2620-1-1.html

rpcserver负责注册登录

wsserver负责登陆后消息传递



消息分类

实时消息、离线消息、历史消息

1）离线消息：

离线消息就是用户（即接收方）在离线过程中收到的消息，这些消息大多是用户比较关心的消息，具有一定的时效性。

以我们的系统经验来说，我们的离线消息默认只保存最近七天的消息。

用户（即接收方）在下次登录后会全量获取这些离线消息，然后在客户端根据聊天会话进行离线消息的UI展示（比如显示一个未读消息气泡等）。

（PS：用户离线的可能性在技术上其实是由很多种情况组成的，比如对方不在线、对方网络断掉了、对方手机崩溃了、服务器发送时出错了等等，严格来讲——只要无法实时发送成的消息，都算“离线消息”。）

2）历史消息：

历史消息存储了用户所有的聊天消息，这些消息包括发出的消息以及接收到的消息。

在客户端获取历史消息时，通常是按照会话进行分页获取的。



## 数据流策略

推模式

app -> IM -> mq -> data transfer消费 -> mongodb
若离线 -> 离线mq -> offline消费 -> 手机sdk推送通知

拉模式

app定时轮询 -> IM -> mongodb 	



由于群聊等，一般使用拉模式

1）由于用户数量太多（观察者），服务器无法一一监控客户端的状态，因此消息模块的数据交互使用拉模式，可以节约服务器资源；
2）当用户有未读消息时，由客户器主动发起请求的方式，可以及时刷新客户端状态。



### 读扩散、写扩散和推拉模式

**读扩散**和**写扩散**是分布式系统和数据管理中的两种策略

* 读扩散，即消息的发布者，将消息存储在自己处，对于消息的订阅/接收者，获取消息时，到消息的发布者存储中，获取（pull）消息，这种模式叫做读扩散，也称为**拉模式**
* 写扩散，即消息的发布者，除了将消息存储在自己处，还会将消息写入（push）到订阅/接收者处，此时订阅/接收者，如果需要获取消息，只需要读取自己处的存储即可，这种模式也称为**推模式**

应用场景

- **读扩散**：适用于查询频繁的应用，如社交媒体、搜索引擎等，能够有效地提供快速响应。
- **写扩散**：适用于数据更新频繁的场景，如在线购物、实时数据分析等，需要保证数据一致性和及时性。

对于IM而言，使用写扩散推模式会导致



feed流

https://www.woshipm.com/marketing/1023818.html

https://www.cnblogs.com/Finley/p/15391173.html







消息风暴和总线风暴



















PUSH 离线推送









业务：http://www.52im.net/thread-812-1-1.html





























